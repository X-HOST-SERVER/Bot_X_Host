import fetch from 'node-fetch'

const nodeToRegion = {
    ae1: 'ğŸ‡¦ğŸ‡ª Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©',
    bg1: 'ğŸ‡§ğŸ‡¬ Ø¨Ù„ØºØ§Ø±ÙŠØ§',
    br1: 'ğŸ‡§ğŸ‡· Ø§Ù„Ø¨Ø±Ø§Ø²ÙŠÙ„',
    ch1: 'ğŸ‡¨ğŸ‡­ Ø³ÙˆÙŠØ³Ø±Ø§',
    cz1: 'ğŸ‡¨ğŸ‡¿ Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„ØªØ´ÙŠÙƒ',
    de1: 'ğŸ‡©ğŸ‡ª Ø£Ù„Ù…Ø§Ù†ÙŠØ§',
    de4: 'ğŸ‡©ğŸ‡ª Ø£Ù„Ù…Ø§Ù†ÙŠØ§',
    es1: 'ğŸ‡ªğŸ‡¸ Ø¥Ø³Ø¨Ø§Ù†ÙŠØ§',
    fi1: 'ğŸ‡«ğŸ‡® ÙÙ†Ù„Ù†Ø¯Ø§',
    fr2: 'ğŸ‡«ğŸ‡· ÙØ±Ù†Ø³Ø§',
    hk1: 'ğŸ‡­ğŸ‡° Ù‡ÙˆÙ†Øº ÙƒÙˆÙ†Øº',
    hr1: 'ğŸ‡­ğŸ‡· ÙƒØ±ÙˆØ§ØªÙŠØ§',
    id1: 'ğŸ‡®ğŸ‡© Ø¥Ù†Ø¯ÙˆÙ†ÙŠØ³ÙŠØ§',
    il1: 'ğŸ‡®ğŸ‡± Ø¥Ø³Ø±Ø§Ø¦ÙŠÙ„',
    il2: 'ğŸ‡®ğŸ‡± Ø¥Ø³Ø±Ø§Ø¦ÙŠÙ„',
    in1: 'ğŸ‡®ğŸ‡³ Ø§Ù„Ù‡Ù†Ø¯',
    ir1: 'ğŸ‡®ğŸ‡· Ø¥ÙŠØ±Ø§Ù†',
    ir3: 'ğŸ‡®ğŸ‡· Ø¥ÙŠØ±Ø§Ù†',
    ir5: 'ğŸ‡®ğŸ‡· Ø¥ÙŠØ±Ø§Ù†',
    it2: 'ğŸ‡®ğŸ‡¹ Ø¥ÙŠØ·Ø§Ù„ÙŠØ§',
    jp1: 'ğŸ‡¯ğŸ‡µ Ø§Ù„ÙŠØ§Ø¨Ø§Ù†',
    kz1: 'ğŸ‡°ğŸ‡¿ ÙƒØ§Ø²Ø§Ø®Ø³ØªØ§Ù†',
    lt1: 'ğŸ‡±ğŸ‡¹ Ù„ÙŠØªÙˆØ§Ù†ÙŠØ§',
    md1: 'ğŸ‡²ğŸ‡© Ù…ÙˆÙ„Ø¯ÙˆÙØ§',
    nl1: 'ğŸ‡³ğŸ‡± Ù‡ÙˆÙ„Ù†Ø¯Ø§',
    nl2: 'ğŸ‡³ğŸ‡± Ù‡ÙˆÙ„Ù†Ø¯Ø§',
    pl1: 'ğŸ‡µğŸ‡± Ø¨ÙˆÙ„Ù†Ø¯Ø§',
    pl2: 'ğŸ‡µğŸ‡± Ø¨ÙˆÙ„Ù†Ø¯Ø§',
    pt1: 'ğŸ‡µğŸ‡¹ Ø§Ù„Ø¨Ø±ØªØºØ§Ù„',
    rs1: 'ğŸ‡·ğŸ‡¸ ØµØ±Ø¨ÙŠØ§',
    ru1: 'ğŸ‡·ğŸ‡º Ø±ÙˆØ³ÙŠØ§',
    ru2: 'ğŸ‡·ğŸ‡º Ø±ÙˆØ³ÙŠØ§',
    ru3: 'ğŸ‡·ğŸ‡º Ø±ÙˆØ³ÙŠØ§',
    se1: 'ğŸ‡¸ğŸ‡ª Ø§Ù„Ø³ÙˆÙŠØ¯',
    tr1: 'ğŸ‡¹ğŸ‡· ØªØ±ÙƒÙŠØ§',
    tr2: 'ğŸ‡¹ğŸ‡· ØªØ±ÙƒÙŠØ§',
    ua1: 'ğŸ‡ºğŸ‡¦ Ø£ÙˆÙƒØ±Ø§Ù†ÙŠØ§',
    ua2: 'ğŸ‡ºğŸ‡¦ Ø£ÙˆÙƒØ±Ø§Ù†ÙŠØ§',
    ua3: 'ğŸ‡ºğŸ‡¦ Ø£ÙˆÙƒØ±Ø§Ù†ÙŠØ§',
    uk1: 'ğŸ‡¬ğŸ‡§ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©',
    us1: 'ğŸ‡ºğŸ‡¸ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø©',
    us2: 'ğŸ‡ºğŸ‡¸ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø©',
    us3: 'ğŸ‡ºğŸ‡¸ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ø§Ù„Ù…ØªØ­Ø¯Ø©',

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    eg1: 'ğŸ‡ªğŸ‡¬ Ù…ØµØ±',
    ma1: 'ğŸ‡²ğŸ‡¦ Ø§Ù„Ù…ØºØ±Ø¨',
    ye1: 'ğŸ‡¾ğŸ‡ª Ø§Ù„ÙŠÙ…Ù†',
    sa1: 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©',
    kw1: 'ğŸ‡°ğŸ‡¼ Ø§Ù„ÙƒÙˆÙŠØª',
    dz1: 'ğŸ‡©ğŸ‡¿ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±',
    jo1: 'ğŸ‡¯ğŸ‡´ Ø§Ù„Ø£Ø±Ø¯Ù†',
    lb1: 'ğŸ‡±ğŸ‡§ Ù„Ø¨Ù†Ø§Ù†',
    qa1: 'ğŸ‡¶ğŸ‡¦ Ù‚Ø·Ø±',
    sy1: 'ğŸ‡¸ğŸ‡¾ Ø³ÙˆØ±ÙŠØ§',
    tn1: 'ğŸ‡¹ğŸ‡³ ØªÙˆÙ†Ø³',
    om1: 'ğŸ‡´ğŸ‡² Ø¹Ù…Ø§Ù†',
    bh1: 'ğŸ‡§ğŸ‡­ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†',
    ps1: 'ğŸ‡µğŸ‡¸ ÙÙ„Ø³Ø·ÙŠÙ†'
};

const handler = async (m, { text, conn }) => {
    if (!text) return conn.reply(m.chat, '```[ğŸ”] .ÙØ­Øµ-Ø§Ù„Ù…ÙˆÙ‚Ø¹ <Ø±Ø§Ø¨Ø·_Ø§Ù„Ù…ÙˆÙ‚Ø¹>```\nÙ…Ø«Ø§Ù„: `.ÙØ­Øµ-Ø§Ù„Ù…ÙˆÙ‚Ø¹ example.com`', m);

    try {
        const response = await fetch(`https://check-host.net/check-http?host=${encodeURIComponent(text)}&max_nodes=43`, {
            headers: { 'Accept': 'application/json' }
        });
        const data = await response.json();
        const { request_id: requestId, permanent_link: reportLink } = data;

        conn.reply(m.chat, `âœ… *ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ!*\nğŸ“„ *ID Ø§Ù„Ø·Ù„Ø¨:* ${requestId}\nğŸ”— *Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ‚Ø±ÙŠØ±:* ${reportLink}\nğŸŒ *Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹:* ${text}`, m);

        await new Promise(resolve => setTimeout(resolve, 5000));

        const response1 = await fetch(`https://check-host.net/check-result/${requestId}`, {
            headers: { 'Accept': 'application/json' }
        });
        const resultData = await response1.json();

        let results = '';
        for (const [node, data] of Object.entries(resultData)) {
            if (Array.isArray(data) && data.length > 0) {
                data.forEach(result => {
                    const region = nodeToRegion[node.split('.')[0]] || 'ğŸŒ Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©';
                    results += `\nğŸŒ *Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:* ${region}\nğŸ“¶ *Ø§Ù„Ø­Ø§Ù„Ø©:* ${result[3]} ${result[2]}\nâ³ *ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:* ${result[1] * 1000} Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©\nğŸ–¥ï¸ *IP:* ${result[4]}\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                });
            }
        }

        if (!results) return conn.reply(m.chat, 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ ØµØ§Ù„Ø­Ø©.', m);

        await conn.reply(m.chat, results, m);
    } catch (error) {
        conn.reply(m.chat, 'ÙØ´Ù„ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.', m)
    }
}

handler.help = ['ÙØ­Øµ-Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'check-host']
handler.tags = ['Ø£Ø¯ÙˆØ§Øª', 'tools']
handler.command = /^(ÙØ­Øµ-Ø§Ù„Ù…ÙˆÙ‚Ø¹|check-host)$/i

export default handler