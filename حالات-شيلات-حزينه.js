import axios from 'axios'

async function ttSearch(query) {
    return new Promise(async (resolve, reject) => {
        axios("https://tikwm.com/api/feed/search", {
            headers: {
                "content-type": "application/x-www-form-urlencoded; charset=UTF-8",
                "cookie": "current_language=en",
                "User-Agent": "Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Mobile Safari/537.36"
            },
            data: {
                "keywords": query,
                "count": 12,
                "cursor": 0,
                "web": 1,
                "hd": 1
            },
            method: "POST"
        }).then(res => {
            resolve(res.data.data)
        }).catch(err => {
            reject(err)
        })
    })
}

let sentVideos = []

let handler = async (m, {
    conn,
    args,
    text,
    usedPrefix,
    command
}) => {
    ttSearch('Ø´ÙŠÙ„Ø§Øª-Ø­Ø²ÙŠÙ†Ù‡').then(a => {
        let videos = a.videos

        videos.sort((v1, v2) => {
            return new Date(v2.created_at) - new Date(v1.created_at)
        })

        let newVideo = null
        for (let video of videos) {
            if (!sentVideos.includes(video.id)) {
                newVideo = video
                break
            }
        }

        if (newVideo) {
            let result = 'https://tikwm.com/' + newVideo.play
            conn.sendMessage(m.chat, {video: {url: result}, caption: 'Ø´ÙŠÙ„Ø§Øª-Ø­Ø²ÙŠÙ†Ù‡\nð‘©ð‘¶ð‘«ð’€ðŸ’€'}, {quoted: m})

            sentVideos.push(newVideo.id)
        } else {
            m.reply('ðŸ’€ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.')
        }
    }).catch(err => {
        m.reply('ðŸ’€ Ø­Ø¯Ø« Ø®Ø·Ø£')
    })
}

handler.help = ['Ø´ÙŠÙ„Ø§Øª-Ø­Ø²ÙŠÙ†Ù‡']
handler.tags = ['random']
handler.command = /^(Ø´ÙŠÙ„Ø§Øª-Ø­Ø²ÙŠÙ†Ù‡)$/i
handler.limit = true
handler.register = true

export default handler